<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مولِّد رمز الاستجابة السريعة</title>
<meta name="theme-color" content="#1e3a8a">
<style>
  :root { --radius:16px; --btnH:36px; }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    min-height:100vh; min-height:100svh;
    display:flex; align-items:center; justify-content:center;
    font-family:Tahoma, Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    background:linear-gradient(135deg,#1e3a8a,#3b82f6,#06b6d4);
    background-size:300% 300%; animation:g 10s ease infinite; color:#111827;
    padding:16px;
  }
  @keyframes g{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .card{
    width:min(96vw,560px);
    background:rgba(255,255,255,.96);
    border:1px solid rgba(17,24,39,.08);
    border-radius:var(--radius);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    padding:clamp(16px,4vw,24px);
    text-align:center;
    margin:auto;
  }
  h2{
    margin:0 0 12px; font-size:clamp(1.1rem,3.5vw,1.4rem);
    color:#0f172a; display:inline-flex; gap:8px; align-items:center; line-height:1.2; justify-content:center;
  }
  .row{display:flex; flex-direction:column; gap:10px; align-items:center}
  label{width:100%;max-width:700px;text-align:right;color:#0f172a;font-size:.95rem}
  input[type="url"]{
    width:100%; max-width:700px; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;
    background:#fff; font-size:1rem; text-align:right; outline:none;
  }
  input[type="url"]:invalid{ border-color:#ef4444 }
  input[type="url"]:valid{ border-color:#10b981 }
  .actions{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; width:100% }
  button{
    height:var(--btnH); padding:0 10px; border:0; border-radius:10px; touch-action:manipulation;
    background:linear-gradient(90deg,#3b82f6,#06b6d4);
    color:#fff; font-size:.9rem; cursor:pointer;
    transition:transform .12s ease, box-shadow .2s ease, opacity .2s ease;
    box-shadow:0 6px 16px rgba(59,130,246,.28); width:140px;
  }
  button[disabled]{opacity:.6; cursor:not-allowed}
  button:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(59,130,246,.35) }
  .btn-outline{ background:#fff; color:#0f172a; border:1px solid #cfd8e3; box-shadow:none }
  #qrbox{ margin-top:12px; width:100% }
  canvas,img{
    display:block; margin-inline:auto;
    border-radius:12px; background:#fff; padding:6px; border:1px solid #e5e7eb;
    width:min(80vw,360px); height:auto;
  }
  .note{ margin-top:6px; font-size:.9rem; color:#6b7280; min-height:1.2em; text-align:center }
  @media (pointer:coarse){ button{ min-height:44px } }
  @media (prefers-reduced-motion: reduce){ body{ animation:none } }
  @media (prefers-color-scheme: dark){
    .card { background: rgba(17,25,40,.9); border-color: rgba(255,255,255,.08); }
    h2, .note, label { color: #e5e7eb; }
    input[type="url"] { background:#0b1220; color:#e5e7eb; border-color:#334155; }
    .btn-outline { background:#0b1220; color:#e5e7eb; border-color:#334155; }
  }
</style>
</head>
<body>
  <div class="card" aria-label="مولّد رمز QR">
    <h2>مولِّد رمز الاستجابة السريعة (QR)</h2>

    <div class="row">
      <label for="link">الرابط</label>
      <input id="link" type="url" placeholder="https://example.com" autocomplete="url" inputmode="url" required />
      <div class="actions">
        <button id="go" type="button" title="إنشاء QR" disabled>إنشاء</button>
        <button id="copyImg" type="button" class="btn-outline" disabled title="نسخ الصورة">نسخ الصورة</button>
        <button id="saveImg" type="button" class="btn-outline" disabled title="حفظ الصورة">حفظ الصورة</button>
      </div>
      <div id="qrbox" aria-live="polite" aria-atomic="true"></div>
      <div id="msg" class="note" aria-live="polite" aria-atomic="true"></div>
    </div>
  </div>

  <!-- JS LIBRARY -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    // Fallback loader if first CDN fails
    (function ensureLib(){
      if (window.QRCode) return;
      var s = document.createElement('script');
      s.src = 'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js';
      document.head.appendChild(s);
    })();

    // --- App code (must exist in the deployed file) ---
    const elBox = document.getElementById('qrbox');
    const elMsg = document.getElementById('msg');
    const btnGo = document.getElementById('go');
    const btnCopyImg = document.getElementById('copyImg');
    const btnSaveImg = document.getElementById('saveImg');
    const linkEl = document.getElementById('link');

    let lastValue = '';
    let resizeTimer;

    function sizes(){
      const vw = Math.min(window.innerWidth, 1400);
      const display = Math.max(160, Math.min(360, Math.floor(vw * 0.8)));
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      return { display, physical: Math.round(display * dpr) };
    }

    function setMsg(t){ elMsg.textContent = t || '' }
    function updateGoState(){ btnGo.disabled = !linkEl.checkValidity(); }

    function clearQR(){
      elBox.innerHTML = '';
      btnCopyImg.disabled = true;
      btnSaveImg.disabled = true;
    }

    function renderQR(text){
      clearQR(); setMsg('');
      const { display, physical } = sizes();

      if (!window.QRCode){
        setMsg('تعذّر تحميل مكتبة QR. أعد التحميل.');
        return;
      }
      new QRCode(elBox, { text, width: physical, height: physical, correctLevel: QRCode.CorrectLevel.M });
      const node = elBox.querySelector('canvas, img');
      if (node){ node.style.width = display + 'px'; node.style.height = display + 'px'; }
      btnCopyImg.disabled = false;
      btnSaveImg.disabled = false;
    }

    function makeQR(){
      if (!linkEl.checkValidity()){ setMsg('أدخل رابطاً صالحاً (https://...)'); return; }
      const v = linkEl.value.trim();
      if (!v){ setMsg('أدخل رابطاً.'); return; }
      lastValue = v;
      renderQR(v);
    }

    async function nodeToCanvas(){
      const node = elBox.querySelector('canvas, img');
      if (!node) throw new Error('لا توجد صورة QR.');
      if (node.tagName.toLowerCase() === 'canvas') return node;

      const c = document.createElement('canvas');
      const s = sizes().physical;
      c.width = s; c.height = s;
      const ctx = c.getContext('2d', { willReadFrequently: true });
      await new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>{ ctx.drawImage(img, 0, 0, s, s); resolve(); };
        img.onerror = ()=>reject(new Error('تعذّر تحويل الصورة.'));
        img.src = node.src;
      });
      return c;
    }

    function canvasToBlob(canvas){
      return new Promise(res=>{
        if (canvas.toBlob) canvas.toBlob(b=>res(b),'image/png');
        else {
          const dataURL = canvas.toDataURL('image/png');
          const bstr = atob(dataURL.split(',')[1]);
          const u8 = new Uint8Array(bstr.length);
          for (let i=0;i<bstr.length;i++) u8[i]=bstr.charCodeAt(i);
          res(new Blob([u8],{type:'image/png'}));
        }
      });
    }

    async function copyImage(){
      try{
        const canvas = await nodeToCanvas();
        const blob = await canvasToBlob(canvas);
        if (navigator.clipboard && window.ClipboardItem){
          await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          setMsg('تم نسخ الصورة.');
        } else {
          setMsg('نسخ الصورة غير مدعوم في هذا المتصفح.');
        }
      }catch(e){ setMsg('تعذّر نسخ الصورة.'); }
    }

    async function saveImage(){
      try{
        const canvas = await nodeToCanvas();
        const blob = await canvasToBlob(canvas);
        const fileName = 'qr.png';

        if (window.showSaveFilePicker) {
          try{
            const handle = await window.showSaveFilePicker({
              suggestedName: fileName,
              types: [{ description:'PNG Image', accept:{'image/png':['.png']} }]
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            setMsg('تم الحفظ في الملفات.');
            return;
          } catch(e) {}
        }

        const file = new File([blob], fileName, { type:'image/png' });
        if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
          await navigator.share({ files:[file], title:'QR' });
          setMsg('تم فتح المشاركة للنظام.');
          return;
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = fileName;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
        setMsg('تم تنزيل الصورة.');
      } catch(e){
        try{
          const canvas = await nodeToCanvas();
          const dataURL = canvas.toDataURL('image/png');
          const w = window.open('', '_blank', 'noopener');
          if (w){
            w.document.write('<meta name="viewport" content="width=device-width,initial-scale=1">');
            w.document.write('<title>QR</title>');
            w.document.write('<style>html,body{margin:0;height:100%}body{display:flex;align-items:center;justify-content:center;background:#fff}</style>');
            w.document.write(`<img alt="QR" src="${dataURL}" style="width:100%;height:auto;max-width:800px;display:block;">`);
            w.document.close();
            setMsg('تم فتح الصورة. احفظها يدوياً.');
            return;
          }
          location.href = dataURL;
          setMsg('تم فتح الصورة.');
        }catch(_){
          setMsg('تعذّر حفظ الصورة.');
        }
      }
    }

    // Wire up
    window.addEventListener('DOMContentLoaded', ()=>{
      btnGo.addEventListener('click', makeQR);
      btnCopyImg.addEventListener('click', copyImage);
      btnSaveImg.addEventListener('click', saveImage);
      linkEl.addEventListener('input', ()=>{ btnGo.disabled = !linkEl.checkValidity(); });
      linkEl.addEventListener('keydown', e=>{ if(e.key==='Enter') makeQR(); });
    });

    window.addEventListener('resize', ()=>{
      if (!lastValue) return;
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=>renderQR(lastValue), 140);
    });
  </script>
</body>
</html>
