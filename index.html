<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مولِّد رمز الاستجابة السريعة</title>
<style>
  :root { --radius: 18px; }
  * { box-sizing: border-box; }
  body{
    margin:0;min-height:100vh;display:grid;place-items:center;
    font-family:Tahoma, Arial, sans-serif;
    background:linear-gradient(135deg,#1e3a8a,#3b82f6,#06b6d4);
    background-size:300% 300%;animation:g 10s ease infinite;color:#111827;
  }
  @keyframes g{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .card{
    width:min(92vw,560px);
    background:rgba(255,255,255,.96);
    border:1px solid rgba(17,24,39,.08);
    border-radius:var(--radius);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    padding:clamp(18px,4vw,28px);
    text-align:center;
  }
  h2{
    margin:0 0 14px;font-size:clamp(1.2rem,3.5vw,1.6rem);
    color:#0f172a;display:inline-flex;gap:8px;align-items:center;line-height:1.2;
  }
  .icon{width:1.6rem;height:1.6rem;fill:#3b82f6}
  .row{display:grid;gap:12px;justify-items:center}
  input[type="text"]{
    width:100%;max-width:700px;padding:12px 14px;border-radius:10px;border:1px solid #d1d5db;
    background:#fff;font-size:1rem;text-align:right;outline:none;
  }
  button{
    padding:12px 16px;border:0;border-radius:10px;background:linear-gradient(90deg,#3b82f6,#06b6d4);
    color:#fff;font-size:1rem;cursor:pointer;transition:transform .15s ease,box-shadow .2s ease;
    box-shadow:0 6px 16px rgba(59,130,246,.35);
  }
  button:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(59,130,246,.4)}
  .btn-outline{
    background:#fff;color:#0f172a;border:1px solid #cfd8e3;box-shadow:none;
  }
  .btn-outline:hover{background:#f8fafc}
  .actions{
    display:grid;gap:10px;margin-top:8px;width:100%;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  }
  #qrbox{margin-top:14px;display:grid;place-items:center}
  canvas,img{
    border-radius:12px;background:#fff;padding:8px;border:1px solid #e5e7eb;
    width:min(85vw,420px);height:auto;
  }
  .note{margin-top:6px;font-size:.9rem;color:#6b7280;min-height:1.2em}
</style>
</head>
<body>
  <div class="card">
    <h2>
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm10-2h6v6h-6V3zm2 2v2h2V5h-2zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm10 0h2v2h-2v-2zm4 0h2v2h-2v-2zm-4 4h2v2h-2v-2zm4 0h2v2h-2v-2zm-4 4h6v2h-6v-2z"/>
      </svg>
      مولِّد رمز الاستجابة السريعة (QR)
    </h2>

    <div class="row">
      <input id="link" type="text" placeholder="أدخل الرابط هنا" autocomplete="on" />
      <div class="actions">
        <button id="go">إنشاء الرمز</button>
        <button id="copyLink" class="btn-outline">نسخ الرابط</button>
        <button id="copyImg" class="btn-outline" disabled>نسخ الصورة</button>
        <button id="saveImg" class="btn-outline" disabled>حفظ الصورة</button>
      </div>
      <div id="qrbox" aria-live="polite"></div>
      <div id="msg" class="note"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    // بديل تلقائي إذا فشل تحميل المصدر الأول
    (function ensureLib(){
      if (window.QRCode) return;
      var s = document.createElement('script');
      s.src = 'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js';
      document.head.appendChild(s);
    })();

    let lastValue = '';
    let resizeTimer;

    const elBox = document.getElementById('qrbox');
    const elMsg = document.getElementById('msg');
    const btnCopyImg = document.getElementById('copyImg');
    const btnSaveImg = document.getElementById('saveImg');

    function displaySizes(){
      const vw = Math.min(window.innerWidth, 1600);
      const display = Math.max(160, Math.min(420, Math.floor(vw * 0.85)));
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      const physical = Math.round(display * dpr);
      return { display, physical };
    }

    function clearQR(){
      elBox.innerHTML = '';
      btnCopyImg.disabled = true;
      btnSaveImg.disabled = true;
    }

    function renderQR(text){
      clearQR();
      elMsg.textContent = '';
      const { display, physical } = displaySizes();

      if (window.QRCode){
        new QRCode(elBox, { text, width: physical, height: physical, correctLevel: QRCode.CorrectLevel.M });
        const el = elBox.querySelector('canvas, img');
        if (el){ el.style.width = display + 'px'; el.style.height = display + 'px'; }
      } else {
        const img = new Image();
        img.alt = 'QR';
        img.src = 'https://api.qrserver.com/v1/create-qr-code/?size='+physical+'x'+physical+'&data=' + encodeURIComponent(text);
        img.onload = () => { img.style.width = display + 'px'; img.style.height = display + 'px'; };
        elBox.appendChild(img);
        elMsg.textContent = 'تم استخدام توليد احتياطي عبر خدمة خارجية.';
      }

      btnCopyImg.disabled = false;
      btnSaveImg.disabled = false;
    }

    function makeQR(){
      const v = (document.getElementById('link').value || '').trim();
      if (!v){ elMsg.textContent = 'الرجاء إدخال رابط صالح.'; return; }
      lastValue = v;
      renderQR(v);
    }

    async function canvasToBlob(canvas){
      if (canvas.toBlob) {
        return new Promise((res) => canvas.toBlob(b => res(b), 'image/png'));
      }
      const dataURL = canvas.toDataURL('image/png');
      return dataURLToBlob(dataURL);
    }

    function dataURLToBlob(dataURL){
      const arr = dataURL.split(','), mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]); let n = bstr.length; const u8 = new Uint8Array(n);
      while (n--) u8[n] = bstr.charCodeAt(n);
      return new Blob([u8], {type: mime});
    }

    async function qrToBlob(){
      const el = elBox.querySelector('canvas, img');
      if (!el) throw new Error('لا توجد صورة QR');
      if (el.tagName.toLowerCase() === 'canvas') {
        return await canvasToBlob(el);
      } else {
        // IMG: قد يكون data: أو رابط خارجي
        try {
          const r = await fetch(el.src, {mode:'cors'});
          return await r.blob();
        } catch(e){
          // محاولة أخيرة: تحويل dataURL محلياً
          if (el.src.startsWith('data:')) return dataURLToBlob(el.src);
          throw e;
        }
      }
    }

    async function copyImage(){
      try {
        const blob = await qrToBlob();
        if (navigator.clipboard && window.ClipboardItem) {
          await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          elMsg.textContent = 'تم نسخ الصورة إلى الحافظة.';
        } else {
          elMsg.textContent = 'نسخ الصورة غير مدعوم. استخدم الحفظ أو انقر بالزر الأيمن/لمس مطوّل.';
        }
      } catch(e){
        elMsg.textContent = 'تعذّر نسخ الصورة.';
      }
    }

    async function saveImage(){
      try {
        const blob = await qrToBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'qr.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1500);
        elMsg.textContent = 'تم حفظ الصورة.';
      } catch(e){
        // فتح الصورة في تبويب جديد كحل أخير (iOS/قيود المتصفح)
        const el = elBox.querySelector('canvas, img');
        if (el && el.src) { window.open(el.src, '_blank'); elMsg.textContent = 'تم فتح الصورة. احفظها يدوياً.'; return; }
        elMsg.textContent = 'تعذّر حفظ الصورة.';
      }
    }

    async function copyLink(){
      const v = (document.getElementById('link').value || '').trim();
      if (!v){ elMsg.textContent = 'لا يوجد رابط لنسخه.'; return; }
      try{
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(v);
        } else {
          const ta = document.createElement('textarea');
          ta.value = v; document.body.appendChild(ta); ta.select();
          document.execCommand('copy'); ta.remove();
        }
        elMsg.textContent = 'تم نسخ الرابط.';
      }catch(e){
        elMsg.textContent = 'تعذّر نسخ الرابط.';
      }
    }

    window.addEventListener('DOMContentLoaded', function(){
      document.getElementById('go').addEventListener('click', makeQR);
      document.getElementById('link').addEventListener('keydown', e => { if (e.key === 'Enter') makeQR(); });
      document.getElementById('copyLink').addEventListener('click', copyLink);
      btnCopyImg.addEventListener('click', copyImage);
      btnSaveImg.addEventListener('click', saveImage);
    });

    window.addEventListener('resize', () => {
      if (!lastValue) return;
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => renderQR(lastValue), 150);
    });
  </script>

  <noscript>
    <div style="position:fixed;inset:0;background:#fff;color:#111;padding:16px;text-align:center;">
      JavaScript مطلوب لعرض رمز QR.
    </div>
  </noscript>
</body>
</html>
