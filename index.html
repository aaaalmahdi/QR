<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مولِّد رمز الاستجابة السريعة</title>
<style>
  :root { --radius:16px; --btnH:36px; }
  *{ box-sizing:border-box }
  body{
    margin:0; min-height:100vh; display:grid; place-items:center;
    font-family:Tahoma, Arial, sans-serif;
    background:linear-gradient(135deg,#1e3a8a,#3b82f6,#06b6d4);
    background-size:300% 300%; animation:g 10s ease infinite; color:#111827;
  }
  @keyframes g{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .card{
    width:min(92vw,520px);
    background:rgba(255,255,255,.96);
    border:1px solid rgba(17,24,39,.08);
    border-radius:var(--radius);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    padding:clamp(16px,4vw,24px);
    text-align:center;
    margin:auto;
  }
  h2{
    margin:0 0 12px; font-size:clamp(1.1rem,3.5vw,1.4rem);
    color:#0f172a; display:inline-flex; gap:8px; align-items:center; line-height:1.2;
  }
  .icon{width:1.4rem; height:1.4rem; fill:#3b82f6}
  .row{display:grid; gap:10px; justify-items:center}
  input[type="text"]{
    width:100%; max-width:680px; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;
    background:#fff; font-size:1rem; text-align:right; outline:none;
  }
  .actions{
    display:grid; gap:8px; width:100%;
    grid-template-columns:repeat(3, minmax(0,1fr));
    justify-items:center; align-items:center;
  }
  button{
    height:var(--btnH); padding:0 12px; border:0; border-radius:10px;
    background:linear-gradient(90deg,#3b82f6,#06b6d4);
    color:#fff; font-size:.9rem; cursor:pointer;
    transition:transform .12s ease, box-shadow .2s ease;
    box-shadow:0 6px 16px rgba(59,130,246,.28); width:100%;
    max-width:150px;
  }
  button:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(59,130,246,.35) }
  .btn-outline{
    background:#fff; color:#0f172a; border:1px solid #cfd8e3; box-shadow:none;
  }
  .btn-outline:hover{ background:#f8fafc }
  #qrbox{ margin-top:12px; display:grid; place-items:center }
  canvas,img{
    border-radius:12px; background:#fff; padding:6px; border:1px solid #e5e7eb;
    width:min(80vw,360px); height:auto;
  }
  .note{ margin-top:6px; font-size:.9rem; color:#6b7280; min-height:1.2em }
  @media (max-width:420px){
    .actions{ grid-template-columns:repeat(2,minmax(0,1fr)) }
  }
</style>
</head>
<body>
  <div class="card">
    <h2>
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm10-2h6v6h-6V3zm2 2v2h2V5h-2zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm10 0h2v2h-2v-2zm4 0h2v2h-2v-2zm-4 4h2v2h-2v-2zm4 0h2v2h-2v-2zm-4 4h6v2h-6v-2z"/>
      </svg>
      مولِّد رمز الاستجابة السريعة (QR)
    </h2>

    <div class="row">
      <input id="link" type="text" placeholder="أدخل الرابط هنا" autocomplete="on" />
      <div class="actions">
        <button id="go">إنشاء</button>
        <button id="copyImg" class="btn-outline" disabled>نسخ الصورة</button>
        <button id="saveImg" class="btn-outline" disabled>حفظ الصورة</button>
      </div>
      <div id="qrbox" aria-live="polite"></div>
      <div id="msg" class="note"></div>
    </div>
  </div>

  <!-- مكتبة QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    // بديل تلقائي إذا فشل المصدر الأول
    (function ensureLib(){
      if (window.QRCode) return;
      var s = document.createElement('script');
      s.src = 'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js';
      document.head.appendChild(s);
    })();

    const elBox = document.getElementById('qrbox');
    const elMsg = document.getElementById('msg');
    const btnCopyImg = document.getElementById('copyImg');
    const btnSaveImg = document.getElementById('saveImg');

    let lastValue = '';
    let resizeTimer;

    function sizes(){
      const vw = Math.min(window.innerWidth, 1400);
      const display = Math.max(160, Math.min(360, Math.floor(vw * 0.8)));
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      return { display, physical: Math.round(display * dpr) };
    }

    function clearQR(){
      elBox.innerHTML = '';
      btnCopyImg.disabled = true;
      btnSaveImg.disabled = true;
    }

    function renderQR(text){
      clearQR(); elMsg.textContent = '';
      const { display, physical } = sizes();

      if (!window.QRCode){
        elMsg.textContent = 'تعذّر تحميل مكتبة QR.';
        return;
      }
      new QRCode(elBox, { text, width: physical, height: physical, correctLevel: QRCode.CorrectLevel.M });
      const node = elBox.querySelector('canvas, img');
      if (node){ node.style.width = display + 'px'; node.style.height = display + 'px'; }
      btnCopyImg.disabled = false;
      btnSaveImg.disabled = false;
    }

    function makeQR(){
      const v = (document.getElementById('link').value || '').trim();
      if (!v){ elMsg.textContent = 'أدخل رابطاً صالحاً.'; return; }
      lastValue = v;
      renderQR(v);
    }

    // تحويل عنصر (Canvas أو IMG) إلى Canvas للاستخدام في النسخ/الحفظ
    async function getCanvas(){
      const node = elBox.querySelector('canvas, img');
      if (!node) throw new Error('لا توجد صورة QR.');

      if (node.tagName.toLowerCase() === 'canvas') return node;

      // IMG -> Canvas
      const c = document.createElement('canvas');
      const s = sizes().physical;
      c.width = s; c.height = s;
      const ctx = c.getContext('2d', { willReadFrequently: true });
      await new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>{ ctx.drawImage(img, 0, 0, s, s); resolve(); };
        img.onerror = ()=>reject(new Error('تعذّر تحويل الصورة.'));
        img.src = node.src;           // data:URI من المكتبة، آمن للسحب للرسم
      });
      return c;
    }

    function canvasToBlob(canvas){
      return new Promise(res=>{
        if (canvas.toBlob) canvas.toBlob(b=>res(b),'image/png');
        else {
          const dataURL = canvas.toDataURL('image/png');
          const bstr = atob(dataURL.split(',')[1]);
          const u8 = new Uint8Array(bstr.length);
          for (let i=0;i<bstr.length;i++) u8[i]=bstr.charCodeAt(i);
          res(new Blob([u8],{type:'image/png'}));
        }
      });
    }

    // نسخ الصورة إلى الحافظة (مدعوم على كروم/أندرويد/سطح المكتب)
    async function copyImage(){
      try{
        const canvas = await getCanvas();
        const blob = await canvasToBlob(canvas);
        if (navigator.clipboard && window.ClipboardItem){
          await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          elMsg.textContent = 'تم نسخ الصورة.';
        } else {
          elMsg.textContent = 'نسخ الصورة غير مدعوم على هذا المتصفح.';
        }
      }catch(e){ elMsg.textContent = 'تعذّر نسخ الصورة.'; }
    }

    // حفظ متوافق مع معظم المتصفحات + دعم iOS عبر فتح تبويب/ورقة مشاركة
    async function saveImage(){
      try{
        const canvas = await getCanvas();
        // مسار 1: ورقة مشاركة بملف (أفضل طريقة للوصول لـ "حفظ الصورة" على iOS/Android الحديث)
        const blob = await canvasToBlob(canvas);
        const file = new File([blob], 'qr.png', { type:'image/png' });
        if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
          await navigator.share({ files:[file], title:'QR' });
          elMsg.textContent = 'تم فتح المشاركة للنظام.';
          return;
        }

        // مسار 2: تنزيل مباشر عبر dataURL (متوافق أكثر من blob على متصفحات عديدة)
        const dataURL = canvas.toDataURL('image/png');

        // كشف iOS/Safari لاستخدام فتح تبويب (download attr غير مدعوم جيداً)
        const ua = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

        if (isIOS || isSafari){
          const w = window.open('', '_blank');           // تبويب بعنصر IMG للحفظ اليدوي
          if (w){
            w.document.write('<meta name="viewport" content="width=device-width,initial-scale=1">');
            w.document.write('<title>QR</title>');
            w.document.write('<style>body{margin:0;display:grid;place-items:center;background:#fff}</style>');
            w.document.write(`<img alt="QR" src="${dataURL}" style="width:100%;height:auto;max-width:800px;display:block;">`);
            w.document.close();
            elMsg.textContent = 'تم فتح الصورة. احفظها من خيارات المتصفح.';
          } else {
            location.href = dataURL;                     // آخر حل على iOS
            elMsg.textContent = 'تم فتح الصورة.';
          }
          return;
        }

        // مسار 3: تنزيل ملف على كروم/أندرويد/سطح المكتب
        const a = document.createElement('a');
        a.href = dataURL; a.download = 'qr.png';
        document.body.appendChild(a); a.click(); a.remove();
        elMsg.textContent = 'تم تنزيل الصورة.';
      } catch(e){
        elMsg.textContent = 'تعذّر حفظ الصورة.';
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('go').addEventListener('click', makeQR);
      document.getElementById('link').addEventListener('keydown', e=>{ if(e.key==='Enter') makeQR(); });
      document.getElementById('copyImg').addEventListener('click', copyImage);
      document.getElementById('saveImg').addEventListener('click', saveImage);
    });

    window.addEventListener('resize', ()=>{
      if (!lastValue) return;
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=>renderQR(lastValue), 140);
    });
  </script>

  <noscript>
    <div style="position:fixed;inset:0;background:#fff;color:#111;padding:16px;text-align:center;">
      JavaScript مطلوب لعرض رمز QR.
    </div>
  </noscript>
</body>
</html>
